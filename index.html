<!DOCTYPE html>
<html>
<head>
    <title>AI 팟캐스트 생성기</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        textarea, input { width: 100%; padding: 10px; margin-bottom: 15px; }
        button { background: #4CAF50; color: white; padding: 10px 15px; border: none; cursor: pointer; }
        button:hover { background: #45a049; }
        #results { margin-top: 20px; }
        .article { margin-bottom: 10px; padding: 10px; background: #f9f9f9; }
    </style>
</head>
<body>
    <div class="container">
        <h1>AI 팟캐스트 생성기</h1>
        
        <form id="feedForm">
            <label for="feedUrl">새 피드 주소 추가:</label>
            <input type="url" id="feedUrl" placeholder="https://example.com/rss.xml" required>
            <button type="submit">피드 추가</button>
        </form>
        <div id="feedBlocks" style="margin:20px 0;"></div>
        <form id="rssForm" style="display:none;">
            <label for="keywords">검색어 (쉼표로 구분):</label>
            <input type="text" id="keywords" placeholder="AI,기술,머신러닝">
            <button type="submit">검색</button>
        </form>
        <div style="font-size:0.9em;color:#888;margin-bottom:10px;">
            피드 주소를 추가하면 아래에 타이틀:피드주소 형태로 저장됩니다.<br>
            피드 블록을 클릭하면 뉴스 검색이 활성화됩니다.<br>
            (데이터는 브라우저에만 저장됩니다. 서버 연동은 Vercel 등에서 feeds.json을 API로 관리해야 합니다.)
        </div>
        
        <div id="results"></div>
        
    <button id="downloadBtn" style="display:none;">주소 다운로드 (TXT)</button>
    </div>

    <script>
        // 서버에서 피드 목록 불러오기 (GET /feeds)
        let feeds = [];
        let selectedFeed = null;

        async function fetchFeeds() {
            try {
                const res = await fetch('/feeds');
                feeds = await res.json();
            } catch {
                feeds = [];
            }
            renderFeedBlocks();
        }

        function renderFeedBlocks() {
            const feedBlocks = document.getElementById('feedBlocks');
            feedBlocks.innerHTML = '';
            feeds.forEach((feed, idx) => {
                const block = document.createElement('div');
                block.className = 'article';
                block.style.cursor = 'pointer';
                block.style.background = selectedFeed === feed.url ? '#d0f0d0' : '#f9f9f9';
                block.innerHTML = `<b>${feed.title}</b>: <span style="font-size:0.9em;">${feed.url}</span>`;
                block.onclick = async () => {
                    selectedFeed = feed.url;
                    renderFeedBlocks();
                    document.getElementById('rssForm').style.display = 'block';
                    document.getElementById('rssForm').dataset.feedurl = feed.url;
                };
                feedBlocks.appendChild(block);
            });
            // 피드가 없으면 입력폼 활성화, 있으면 비활성화
            document.getElementById('feedUrl').disabled = feeds.length > 0;
            document.querySelector('#feedForm button[type="submit"]').disabled = feeds.length > 0;
        }

        document.getElementById('feedForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const url = document.getElementById('feedUrl').value.trim();
            if (!url || feeds.some(f => f.url === url)) return;
            // 피드 타이틀 가져오기
            try {
                const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(url);
                const response = await fetch(proxyUrl);
                const xmlText = await response.text();
                const parser = new DOMParser();
                const xml = parser.parseFromString(xmlText, 'text/xml');
                const title = xml.querySelector('channel>title, feed>title')?.textContent || '제목 없음';
                // 서버에 피드 추가 요청 (POST /feeds) - 실제 구현 필요
                // 임시로 클라이언트에서만 추가
                feeds.push({ url, title });
                renderFeedBlocks();
                document.getElementById('feedUrl').value = '';
            } catch {
                alert('피드 정보를 불러올 수 없습니다. 주소를 확인하세요.');
            }
        });

        document.getElementById('rssForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const rssUrl = e.target.dataset.feedurl;
            const keywords = document.getElementById('keywords').value.split(',').map(k => k.trim());
            const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(rssUrl);
            try {
                const response = await fetch(proxyUrl);
                const xmlText = await response.text();
                const parser = new DOMParser();
                const xml = parser.parseFromString(xmlText, 'text/xml');
                const items = Array.from(xml.querySelectorAll('item, entry'));
                const articles = items.map(item => {
                    const title = item.querySelector('title')?.textContent || '제목 없음';
                    const description = item.querySelector('description, summary, content')?.textContent || '';
                    const link = item.querySelector('link')?.getAttribute('href') || item.querySelector('link')?.textContent || '#';
                    return { title, description, link };
                }).filter(article => {
                    if (!keywords.some(k => k)) return true;
                    const content = (article.title + ' ' + article.description).toLowerCase();
                    return keywords.some(keyword => keyword && content.includes(keyword.toLowerCase()));
                });
                displayResults(articles);
            } catch (err) {
                document.getElementById('results').innerHTML = '<p style="color:red;">RSS 처리 중 오류가 발생했습니다.<br>피드 주소와 CORS 정책을 확인하세요.</p>';
                document.getElementById('downloadBtn').style.display = 'none';
            }
        });

        function displayResults(articles) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            if (!articles || articles.length === 0) {
                resultsDiv.innerHTML = '<p>검색 결과가 없습니다.</p>';
                document.getElementById('downloadBtn').style.display = 'none';
                return;
            }
            articles.forEach(article => {
                const articleDiv = document.createElement('div');
                articleDiv.className = 'article';
                articleDiv.innerHTML = `
                    <h3><a href="${article.link}" target="_blank">${article.title}</a></h3>
                    <p>${article.description || '설명 없음'}</p>
                    <p class="link">${article.link}</p>
                `;
                resultsDiv.appendChild(articleDiv);
            });
            document.getElementById('downloadBtn').style.display = 'block';
            document.getElementById('downloadBtn').onclick = function() {
                const links = articles.map(a => a.link).join('\n');
                downloadAsTxt(links, 'ai_podcast_links.txt');
            };
        }
        function downloadAsTxt(text, filename) {
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        // 최초 서버에서 피드 목록 불러오기
        fetchFeeds();
    </script>
</body>
</html>
